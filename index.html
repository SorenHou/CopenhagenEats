<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Copenhagen Eats</title>
    <!-- Google Font: Oswald -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Oswald&display=swap" />
    <!-- Custom styles -->
    <link rel="stylesheet" href="style/styles.css">
    <meta http-equiv="Permissions-Policy" content="interest-cohort=()">
  </head>

  <body>
    <!-- Header section -->
    <header>
      <h1>Copenhagen Eats</h1>
      <p>Discover great places to eat in Copenhagen</p>
    </header>

    <!-- Main container -->
    <div class="main-container">
      <!-- Map container -->
      <div id="map"></div>

      <!-- Locations pane -->
      <div id="locations-pane">
        <!-- Filter by price title -->
        <h3>Filter by price</h3>
        <!-- Filter container -->
        <div class="filter-container">
          <!-- Filter item: 0-300 DKK -->
          <div class="filter-item">
            <input type="checkbox" id="price-0-300" checked />
            <label for="price-0-300">
              <img src="https://raw.githubusercontent.com/SorenHou/CopenhagenEats/main/YellowIcon.png" alt="0-300 DKK" />
              0-300 DKK
            </label>
          </div>
          <!-- Filter item: 300-600 DKK -->
          <div class="filter-item">
            <input type="checkbox" id="price-300-600" checked />
            <label for="price-300-600">
              <img src="https://raw.githubusercontent.com/SorenHou/CopenhagenEats/main/BlueIcon.png" alt="300-600 DKK" />
              300-600 DKK
            </label>
          </div>
          <!-- Filter item: 600+ DKK -->
          <div class="filter-item">
            <input type="checkbox" id="price-600-plus" checked />
            <label for="price-600-plus">
              <img src="https://raw.githubusercontent.com/SorenHou/CopenhagenEats/main/RedIcon.png" alt="600+ DKK" />
              600+ DKK
            </label>
          </div>
        </div>
      </div>
    </div>

<script>
  const allLocations = [];
  const allMarkers = [];

/**
 * Parses the given CSV text and returns an array of objects.
 * @param {string} text - The CSV text to parse.
 * @param {string} [delimiter=','] - The delimiter used to separate fields in the CSV.
 * @returns {Array} An array of objects representing the rows of the CSV.
 */
 function parseCSV(text, delimiter = ",") {
  // Trim any leading/trailing whitespace, split the CSV text into an array of rows
  const rows = text.trim().split("\n");

  // Remove the header row from the rows array and split it into an array of header columns
  const header = rows.shift();
  const headerColumns = header.split(delimiter);

  // Map each row of the CSV file to an object
  const data = rows.map((row) => {
    const rowData = {};
    let start = 0;
    let inQuotes = false;

    // Iterate through each header column
    for (let i = 0; i < headerColumns.length; i++) {
      let end = start;

      // Find the end of the current field in the row
      while (end < row.length) {
        // If the current character is a quote and is not escaped
        if (row[end] === '"' && (end === 0 || row[end - 1] !== '\\')) {
          // Toggle the inQuotes flag
          inQuotes = !inQuotes;
        } else if (row[end] === delimiter && !inQuotes) {
          // If the current character is the delimiter and we are not inside quotes, break the loop
          break;
        }
        end++;
      }

      // Get the field value, remove quotes from the start and end, and unescape double quotes
      const fieldValue = row
        .slice(start, end)
        .replace(/^"|"$/g, "")
        .replace(/""/g, '"');

      // Add the field value to the rowData object using the corresponding header column as the key
      rowData[headerColumns[i]] = fieldValue;

      // Update the start position for the next field
      start = end + 1;
    }

    return rowData;
  });

  return data;
}


  function filterLocations() {
    const showPrice0to300 = document.getElementById('price-0-300').checked;
    const showPrice300to600 = document.getElementById('price-300-600').checked;
    const showPrice600Plus = document.getElementById('price-600-plus').checked;

    const noFiltersSelected = !showPrice0to300 && !showPrice300to600 && !showPrice600Plus;

    // Iterate over all locations and markers
    for (let i = 0; i < allLocations.length; i++) {
      const location = allLocations[i];
      const marker = allMarkers[i];

      const styleUrl = allLocations[i].styleUrl;

        let shouldShow = false;
        if (styleUrl === '#yellow-icon-style' && (showPrice0to300 || noFiltersSelected)) {
          shouldShow = true;
        } else if (styleUrl === '#blue-icon-style' && (showPrice300to600 || noFiltersSelected)) {
          shouldShow = true;
        } else if (styleUrl === '#red-icon-style' && (showPrice600Plus || noFiltersSelected)) {
          shouldShow = true;
        }

        location.locationDiv.style.display = shouldShow ? '' : 'none';
      marker.setVisible(shouldShow);
    }
  }


  async function fetchLocationDataFromGoogleSheets() {
  const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSsXXnPFPRmhRnIanXBwugcmPe-oZDUrD5Ka7rKfm79NHiTdoR7Bgirl0bjjWZiFo8Xzo8TbMOMSwkg/pub?gid=1752772653&single=true&output=csv';
  const response = await fetch(sheetUrl);
  const data = await response.text();
  const locationData = parseCSV(data);

locationData.forEach((row) => {
  const {
    name,
    description,
    lat,
    lng,
    styleUrl,
    iconHref,
    website,
    instagram,
    imageUrl,
  } = row;


    const locationCoords = {
      lat: parseFloat(lat),
      lng: parseFloat(lng),
    };

    const locationDiv = document.createElement('div');
    locationDiv.classList.add('location');

    const locationName = document.createElement('h3');
    locationName.textContent = name;
    locationDiv.appendChild(locationName);

    const locationDescription = document.createElement('p');
    locationDescription.innerHTML = `${description}<br><a href="${website}" target="_blank">Website</a><br><a href="${instagram}" target="_blank">Instagram</a>`;
    locationDiv.appendChild(locationDescription);

    if (imageUrl) {
      const locationImage = document.createElement('img');
      locationImage.src = imageUrl;
      locationImage.alt = name;
      locationDiv.appendChild(locationImage);
    }

    locationDiv.addEventListener('click', () => {
      map.setCenter(locationCoords);
      map.setZoom(16);
      if (currentInfoWindow) {
        currentInfoWindow.close();
      }
      infowindow.open(map, marker);
      currentInfoWindow = infowindow;
    });

    const locationsPane = document.getElementById('locations-pane');
    locationsPane.appendChild(locationDiv);

    const iconSize = new google.maps.Size(32, 32); // Adjust these values to change the icon size
    const marker = new google.maps.Marker({
      position: locationCoords,
      map: map,
      title: name,
      icon: {
        url: iconHref,
        scaledSize: iconSize,
      },
    });

    const infowindow = new google.maps.InfoWindow({
      content: `<h3>${name}</h3><p>${description}</p><a href="${website}" target="_blank">Website</a><br><a href="${instagram}" target="_blank">Instagram</a>`,
    });

    marker.addListener('click', () => {
      if (currentInfoWindow) {
        currentInfoWindow.close();
      }
      infowindow.open(map, marker);
      currentInfoWindow = infowindow;
    });

    allLocations.push({ locationDiv, styleUrl });
    allMarkers.push(marker);
  });
}

/*
  async function fetchLocationDataFromKml() {
    const response = await fetch('https://raw.githubusercontent.com/SorenHou/CopenhagenEats/main/MapFile.kml');
    const data = await response.text();
    const parser = new DOMParser();
    const kml = parser.parseFromString(data, 'application/xml');

    const folders = kml.querySelectorAll('Folder');
    console.log('Folders:', folders.length);
    folders.forEach((folder, folderIndex) => {
      const placemarks = folder.querySelectorAll('Placemark');
      console.log(`Folder ${folderIndex + 1} Placemarks:`, placemarks.length);
      placemarks.forEach((placemark) => {
        const nameElement = placemark.querySelector('name');
        const descriptionElement = placemark.querySelector('description');
        const coordinatesElement = placemark.querySelector('coordinates');
        const styleUrlElement = placemark.querySelector('styleUrl');

        if (nameElement && coordinatesElement && styleUrlElement) {
          const name = nameElement.textContent;
          const description = descriptionElement ? descriptionElement.textContent : '';
          const coordinatesText = coordinatesElement.textContent;
          const coordinatesArray = coordinatesText.split(',').map(parseFloat);
          const locationCoords = {
            lat: coordinatesArray[1],
            lng: coordinatesArray[0],
          };

          const styleUrl = styleUrlElement.textContent;
          const iconStyle = kml.querySelector(`Style[id="${styleUrl.slice(1)}"]`);
          const iconHrefElement = iconStyle.querySelector('href');
          const iconHref = iconHrefElement ? iconHrefElement.textContent : '';

          const locationDiv = document.createElement('div');
          locationDiv.classList.add('location');

          const locationName = document.createElement('h3');
          locationName.textContent = name;
          locationDiv.appendChild(locationName);

          const locationDescription = document.createElement('p');
          locationDescription.textContent = description;
          locationDiv.appendChild(locationDescription);

          locationDiv.addEventListener('click', () => {
          map.setCenter(locationCoords);
          map.setZoom(16);
          if (currentInfoWindow) {
            currentInfoWindow.close();
          }
          infowindow.open(map, marker);
          currentInfoWindow = infowindow;
        });



          const locationsPane = document.getElementById('locations-pane');
          locationsPane.appendChild(locationDiv);

          const iconSize = new google.maps.Size(32, 32); // Adjust these values to change the icon size
          const marker = new google.maps.Marker({
                    position: locationCoords,
          map: map,
          title: name,
          icon: {
            url: iconHref,
            scaledSize: iconSize,
          },
        });

        const infowindow = new google.maps.InfoWindow({
          content: `<h3>${name}</h3><p>${description}</p>`,
        });

        marker.addListener('click', () => {
          if (currentInfoWindow) {
            currentInfoWindow.close();
  }
  infowindow.open(map, marker);
  currentInfoWindow = infowindow;
});


        allLocations.push({ locationDiv, styleUrl });
        allMarkers.push(marker);


      }
    });
  });
}

*/

        // Add event listeners for checkboxes
        document.getElementById('price-0-300').addEventListener('change', filterLocations);
        document.getElementById('price-300-600').addEventListener('change', filterLocations);
        document.getElementById('price-600-plus').addEventListener('change', filterLocations);

let map;
let currentInfoWindow;


function initMap() {
  map = new google.maps.Map(document.getElementById('map'), {
    zoom: 12,
    center: { lat: 55.6761, lng: 12.5683 }, // Center the map on Copenhagen
  });
  fetchLocationDataFromGoogleSheets();
  //fetchLocationDataFromKml(); // Remove if it works
}

function loadGoogleMapsApi() {
  const script = document.createElement('script');
  script.src = 'https://maps.googleapis.com/maps/api/js?key=AIzaSyDTV1aLFYT4vIK6FhFJnqRflsrtRGpbd1I&callback=initMap';
  script.async = true;
  script.defer = true;
  document.body.appendChild(script);
}

window.addEventListener('DOMContentLoaded', loadGoogleMapsApi);
</script>

</body>
</html>
